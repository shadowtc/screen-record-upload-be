version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: minio-upload-mysql
    environment:
      - MYSQL_ROOT_PASSWORD=${DB_PASSWORD:-root123}
      - MYSQL_DATABASE=${DB_NAME:-minio_upload}
      - MYSQL_USER=${DB_USERNAME:-minioadmin}
      - MYSQL_PASSWORD=${DB_PASSWORD:-root123}
    ports:
      - "3306:3306"
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - minio-network
    restart: unless-stopped
    command: --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB_PASSWORD:-root123}"]
      interval: 10s
      timeout: 5s
      retries: 5

  app:
    build: .
    ports:
      - "8080:8080"
    environment:
      - DB_URL=jdbc:mysql://mysql:3306/${DB_NAME:-minio_upload}?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
      - DB_USERNAME=${DB_USERNAME:-root}
      - DB_PASSWORD=${DB_PASSWORD:-root123}
      - S3_ENDPOINT=${S3_ENDPOINT:-http://192.168.0.245:9000}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY:-minioadmin}
      - S3_SECRET_KEY=${S3_SECRET_KEY:-minioadmin123}
      - S3_BUCKET=${S3_BUCKET:-remote-consent}
      - S3_REGION=${S3_REGION:-us-east-1}
      - S3_PATH_STYLE=${S3_PATH_STYLE:-true}
      - UPLOAD_MAX_SIZE=${UPLOAD_MAX_SIZE:-2147483648}
      - UPLOAD_CHUNK_SIZE=${UPLOAD_CHUNK_SIZE:-8388608}
      - PRESIGNED_URL_EXPIRATION=${PRESIGNED_URL_EXPIRATION:-60}
      # Video compression environment variables
      - VIDEO_TEMP_DIR=${VIDEO_TEMP_DIR:-/tmp/video-compression}
      - VIDEO_MAX_JOBS=${VIDEO_MAX_JOBS:-2}
      - VIDEO_MAX_SIZE=${VIDEO_MAX_SIZE:-1073741824}
      - VIDEO_TIMEOUT=${VIDEO_TIMEOUT:-300}
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - minio-network
    restart: unless-stopped
    # Resource allocation for video compression
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G
    volumes:
      - video-temp:/tmp/video-compression

networks:
  minio-network:
    driver: bridge

volumes:
  mysql-data:
  video-temp:
